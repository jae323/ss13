--// SMART SPECIAL KILLING AIM LOCK SCRIPT WITH FOV + GUI SYSTEM + WALL CHECK + HITBOX + VERSION SELECTION //--

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local camera = workspace.CurrentCamera
local player = Players.LocalPlayer

-- Config
local aimPartName = "Head"
local zombiesFolder = workspace:WaitForChild("Zombies")

-- State
local aimLockActive = false
local aimFOV = 100
local draggingSlider = false
local uiVisible = true
local fovVisible = true
local espVisible = false
local wallCheckEnabled = true
local hitboxEnabled = false

-- NEW: Version system
local currentVersion = "Main" -- "Main", "OnlySniper", "IgnoreWraith", "SmartSpecialKilling"
local versionButtonColors = {}
local versionFrameVisible = false

-- NEW: Smart Special Killing variables
local GUARDIAN_PRIORITY_RANGE = 50 -- Distance to prioritize GuardianZombie when near closest zombie
local BOSS_IGNORE_HP_THRESHOLD = 0.5 -- 50% HP
local BOSS_IGNORE_DURATION = 8 -- Seconds to ignore Boss
local bossIgnoreTimers = {} -- Table to track boss ignore timers

-- NEW: Smooth aiming variables
local smoothAimEnabled = false
local smoothnessAmount = 1.5 -- Default smoothness
local lastCameraCFrame = camera.CFrame

-- ESP storage
local espObjects = {}

-- Platform detection
local isPC = UserInputService:GetPlatform() == Enum.Platform.Windows
local aimbindKey = Enum.KeyCode.Q -- Default keybind for PC
local waitingForKeybind = false

----------------------------------------------------------------
-- GUI SYSTEM
----------------------------------------------------------------
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "AimLockGui"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

-- Main Frame
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 260, 0, 520)
mainFrame.Position = UDim2.new(0.5, -130, 0.5, -85)
mainFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
mainFrame.BorderSizePixel = 0
mainFrame.Parent = screenGui
mainFrame.Active = true
mainFrame.Draggable = true

-- Toggle AimLock Button
local toggleButton = Instance.new("TextButton")
toggleButton.Size = UDim2.new(0, 200, 0, 40)
toggleButton.Position = UDim2.new(0, 30, 0, 10)
toggleButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
toggleButton.Text = "AimLock Off"
toggleButton.Parent = mainFrame
toggleButton.TextColor3 = Color3.new(1,1,1)
toggleButton.Font = Enum.Font.SourceSansBold
toggleButton.TextSize = 20

toggleButton.MouseButton1Click:Connect(function()
    aimLockActive = not aimLockActive
    toggleButton.Text = aimLockActive and "AimLock On" or "AimLock Off"
    toggleButton.BackgroundColor3 = aimLockActive and Color3.fromRGB(0,255,0) or Color3.fromRGB(255,0,0)
end)

-- FOV Controls
local fovLabel = Instance.new("TextLabel")
fovLabel.Size = UDim2.new(0, 200, 0, 25)
fovLabel.Position = UDim2.new(0, 30, 0, 60)
fovLabel.BackgroundTransparency = 1
fovLabel.TextColor3 = Color3.new(1,1,1)
fovLabel.Text = "Aim FOV: " .. aimFOV
fovLabel.Font = Enum.Font.SourceSans
fovLabel.TextSize = 18
fovLabel.Parent = mainFrame

local slider = Instance.new("TextButton")
slider.Size = UDim2.new(0, 200, 0, 20)
slider.Position = UDim2.new(0, 30, 0, 90)
slider.BackgroundColor3 = Color3.fromRGB(90, 90, 90)
slider.Text = ""
slider.Parent = mainFrame

local sliderKnob = Instance.new("Frame")
sliderKnob.Size = UDim2.new(0, 10, 0, 20)
sliderKnob.Position = UDim2.new(0, (aimFOV / 300) * 200, 0, 0)
sliderKnob.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
sliderKnob.Parent = slider

slider.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        draggingSlider = true
    end
end)

slider.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        draggingSlider = false
    end
end)

-- FOV Circle Drawing
local fovCircle = Drawing.new("Circle")
fovCircle.Color = Color3.fromRGB(0, 170, 255)
fovCircle.Thickness = 2
fovCircle.NumSides = 64
fovCircle.Radius = aimFOV
fovCircle.Filled = false
fovCircle.Visible = true

-- UI Toggle Button (outside main frame)
local toggleUIBtn = Instance.new("TextButton")
toggleUIBtn.Size = UDim2.new(0, 100, 0, 40)
toggleUIBtn.Position = UDim2.new(0, 10, 0, 10)
toggleUIBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 255)
toggleUIBtn.Text = "Hide UI"
toggleUIBtn.Parent = screenGui
toggleUIBtn.TextColor3 = Color3.new(1,1,1)
toggleUIBtn.Font = Enum.Font.SourceSansBold
toggleUIBtn.TextSize = 20

-- FOV Circle Toggle
local toggleFovBtn = Instance.new("TextButton")
toggleFovBtn.Size = UDim2.new(0, 200, 0, 40)
toggleFovBtn.Position = UDim2.new(0, 30, 0, 120)
toggleFovBtn.BackgroundColor3 = Color3.fromRGB(255, 255, 0)
toggleFovBtn.Text = "Hide FOV Circle"
toggleFovBtn.Parent = mainFrame
toggleFovBtn.TextColor3 = Color3.new(1,1,1)
toggleFovBtn.Font = Enum.Font.SourceSansBold
toggleFovBtn.TextSize = 20

-- ESP Toggle
local toggleEspBtn = Instance.new("TextButton")
toggleEspBtn.Size = UDim2.new(0, 200, 0, 40)
toggleEspBtn.Position = UDim2.new(0, 30, 0, 170)
toggleEspBtn.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
toggleEspBtn.Text = "Hide Body ESP Zombies"
toggleEspBtn.Parent = mainFrame
toggleEspBtn.TextColor3 = Color3.new(1,1,1)
toggleEspBtn.Font = Enum.Font.SourceSansBold
toggleEspBtn.TextSize = 20

-- Wall Check Toggle
local toggleWallCheckBtn = Instance.new("TextButton")
toggleWallCheckBtn.Size = UDim2.new(0, 200, 0, 40)
toggleWallCheckBtn.Position = UDim2.new(0, 30, 0, 220)
toggleWallCheckBtn.BackgroundColor3 = Color3.fromRGB(255, 100, 100)
toggleWallCheckBtn.Text = "Disable Wall Check"
toggleWallCheckBtn.Parent = mainFrame
toggleWallCheckBtn.TextColor3 = Color3.new(1,1,1)
toggleWallCheckBtn.Font = Enum.Font.SourceSansBold
toggleWallCheckBtn.TextSize = 20

-- Hitbox Toggle
local hitboxToggle = Instance.new("TextButton")
hitboxToggle.Size = UDim2.new(0, 200, 0, 40)
hitboxToggle.Position = UDim2.new(0, 30, 0, 270)
hitboxToggle.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
hitboxToggle.TextColor3 = Color3.new(1, 1, 1)
hitboxToggle.Font = Enum.Font.SourceSansBold
hitboxToggle.TextSize = 20
hitboxToggle.Text = "Expand Hitbox: OFF"
hitboxToggle.Parent = mainFrame

-- Hitbox Selection Buttons
local hitboxHeadBtn = Instance.new("TextButton")
hitboxHeadBtn.Size = UDim2.new(0, 95, 0, 40)
hitboxHeadBtn.Position = UDim2.new(0, 30, 0, 320)
hitboxHeadBtn.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
hitboxHeadBtn.Text = "Head"
hitboxHeadBtn.Parent = mainFrame
hitboxHeadBtn.TextColor3 = Color3.new(1,1,1)
hitboxHeadBtn.Font = Enum.Font.SourceSansBold
hitboxHeadBtn.TextSize = 18

local hitboxTorsoBtn = Instance.new("TextButton")
hitboxTorsoBtn.Size = UDim2.new(0, 95, 0, 40)
hitboxTorsoBtn.Position = UDim2.new(0, 135, 0, 320)
hitboxTorsoBtn.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
hitboxTorsoBtn.Text = "Torso"
hitboxTorsoBtn.Parent = mainFrame
hitboxTorsoBtn.TextColor3 = Color3.new(1,1,1)
hitboxTorsoBtn.Font = Enum.Font.SourceSansBold
hitboxTorsoBtn.TextSize = 18

-- NEW: Smooth Aim Toggle
local smoothAimToggle = Instance.new("TextButton")
smoothAimToggle.Size = UDim2.new(0, 200, 0, 40)
smoothAimToggle.Position = UDim2.new(0, 30, 0, 370)
smoothAimToggle.BackgroundColor3 = Color3.fromRGB(120, 0, 200)
smoothAimToggle.TextColor3 = Color3.new(1, 1, 1)
smoothAimToggle.Font = Enum.Font.SourceSansBold
smoothAimToggle.TextSize = 20
smoothAimToggle.Text = "Smooth Aim: OFF"
smoothAimToggle.Parent = mainFrame

-- NEW: Smoothness Selection Buttons
local smoothnessLabel = Instance.new("TextLabel")
smoothnessLabel.Size = UDim2.new(0, 200, 0, 25)
smoothnessLabel.Position = UDim2.new(0, 30, 0, 420)
smoothnessLabel.BackgroundTransparency = 1
smoothnessLabel.TextColor3 = Color3.new(1,1,1)
smoothnessLabel.Text = "Smoothness: 1.5"
smoothnessLabel.Font = Enum.Font.SourceSans
smoothnessLabel.TextSize = 16
smoothnessLabel.Parent = mainFrame

local smoothness15Btn = Instance.new("TextButton")
smoothness15Btn.Size = UDim2.new(0, 60, 0, 30)
smoothness15Btn.Position = UDim2.new(0, 30, 0, 450)
smoothness15Btn.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
smoothness15Btn.Text = "1.5"
smoothness15Btn.Parent = mainFrame
smoothness15Btn.TextColor3 = Color3.new(1,1,1)
smoothness15Btn.Font = Enum.Font.SourceSansBold
smoothness15Btn.TextSize = 16

local smoothness20Btn = Instance.new("TextButton")
smoothness20Btn.Size = UDim2.new(0, 60, 0, 30)
smoothness20Btn.Position = UDim2.new(0, 100, 0, 450)
smoothness20Btn.BackgroundColor3 = Color3.fromRGB(90, 90, 90)
smoothness20Btn.Text = "2.0"
smoothness20Btn.Parent = mainFrame
smoothness20Btn.TextColor3 = Color3.new(1,1,1)
smoothness20Btn.Font = Enum.Font.SourceSansBold
smoothness20Btn.TextSize = 16

local smoothness25Btn = Instance.new("TextButton")
smoothness25Btn.Size = UDim2.new(0, 60, 0, 30)
smoothness25Btn.Position = UDim2.new(0, 170, 0, 450)
smoothness25Btn.BackgroundColor3 = Color3.fromRGB(90, 90, 90)
smoothness25Btn.Text = "2.5"
smoothness25Btn.Parent = mainFrame
smoothness25Btn.TextColor3 = Color3.new(1,1,1)
smoothness25Btn.Font = Enum.Font.SourceSansBold
smoothness25Btn.TextSize = 16

-- Version Selection Button (outside main frame)
local versionSelectBtn = Instance.new("TextButton")
versionSelectBtn.Size = UDim2.new(0, 120, 0, 40)
versionSelectBtn.Position = UDim2.new(0, 10, 0, 60)
versionSelectBtn.BackgroundColor3 = Color3.fromRGB(150, 100, 200)
versionSelectBtn.Text = "Select Version"
versionSelectBtn.Parent = screenGui
versionSelectBtn.TextColor3 = Color3.new(1,1,1)
versionSelectBtn.Font = Enum.Font.SourceSansBold
versionSelectBtn.TextSize = 16

-- UI Toggle Handler
toggleUIBtn.MouseButton1Click:Connect(function()
    uiVisible = not uiVisible
    mainFrame.Visible = uiVisible
    toggleUIBtn.Text = uiVisible and "Hide UI" or "Show UI"
end)

-- FOV Circle Toggle Handler
toggleFovBtn.MouseButton1Click:Connect(function()
    fovVisible = not fovVisible
    fovCircle.Visible = fovVisible
    toggleFovBtn.Text = fovVisible and "Hide FOV Circle" or "Show FOV Circle"
end)

-- Wall Check Toggle Handler
toggleWallCheckBtn.MouseButton1Click:Connect(function()
    wallCheckEnabled = not wallCheckEnabled
    toggleWallCheckBtn.Text = wallCheckEnabled and "Disable Wall Check" or "Enable Wall Check"
    toggleWallCheckBtn.BackgroundColor3 = wallCheckEnabled and Color3.fromRGB(255, 100, 100) or Color3.fromRGB(100, 255, 100)
end)

-- Hitbox Selection Handlers
hitboxHeadBtn.MouseButton1Click:Connect(function()
    aimPartName = "Head"
    hitboxHeadBtn.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
    hitboxTorsoBtn.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
end)

hitboxTorsoBtn.MouseButton1Click:Connect(function()
    aimPartName = "HumanoidRootPart"
    hitboxHeadBtn.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
    hitboxTorsoBtn.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
end)

-- NEW: Smooth Aim Toggle Handler
smoothAimToggle.MouseButton1Click:Connect(function()
    smoothAimEnabled = not smoothAimEnabled
    smoothAimToggle.Text = smoothAimEnabled and "Smooth Aim: ON" or "Smooth Aim: OFF"
    smoothAimToggle.BackgroundColor3 = smoothAimEnabled and Color3.fromRGB(180, 0, 255) or Color3.fromRGB(120, 0, 200)
end)

-- NEW: Smoothness Selection Handlers
smoothness15Btn.MouseButton1Click:Connect(function()
    smoothnessAmount = 1.5
    smoothnessLabel.Text = "Smoothness: 1.5"
    smoothness15Btn.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
    smoothness20Btn.BackgroundColor3 = Color3.fromRGB(90, 90, 90)
    smoothness25Btn.BackgroundColor3 = Color3.fromRGB(90, 90, 90)
end)

smoothness20Btn.MouseButton1Click:Connect(function()
    smoothnessAmount = 2.0
    smoothnessLabel.Text = "Smoothness: 2.0"
    smoothness15Btn.BackgroundColor3 = Color3.fromRGB(90, 90, 90)
    smoothness20Btn.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
    smoothness25Btn.BackgroundColor3 = Color3.fromRGB(90, 90, 90)
end)

smoothness25Btn.MouseButton1Click:Connect(function()
    smoothnessAmount = 2.5
    smoothnessLabel.Text = "Smoothness: 2.5"
    smoothness15Btn.BackgroundColor3 = Color3.fromRGB(90, 90, 90)
    smoothness20Btn.BackgroundColor3 = Color3.fromRGB(90, 90, 90)
    smoothness25Btn.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
end)

----------------------------------------------------------------
-- VERSION SELECTION GUI (RIÊNG BIỆT)
----------------------------------------------------------------
local versionFrame

local function createVersionSelectionGUI()
    versionFrame = Instance.new("Frame")
    versionFrame.Size = UDim2.new(0, 260, 0, 180)
    versionFrame.Position = UDim2.new(0.5, -130, 0.5, 100)
    versionFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    versionFrame.BorderSizePixel = 0
    versionFrame.Parent = screenGui
    versionFrame.Visible = false
    versionFrame.Active = true
    versionFrame.Draggable = true
    
    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, 0, 0, 30)
    title.Position = UDim2.new(0, 0, 0, 0)
    title.BackgroundColor3 = Color3.fromRGB(60, 60, 80)
    title.BorderSizePixel = 0
    title.Text = "SELECT AIMBOT VERSION"
    title.TextColor3 = Color3.new(1,1,1)
    title.Font = Enum.Font.SourceSansBold
    title.TextSize = 16
    title.Parent = versionFrame
    
    -- Function to generate a random color
    local function getRandomColor()
        return Color3.new(math.random(), math.random(), math.random())
    end
    
    -- Generate random colors for each version
    versionButtonColors = {
        Main = getRandomColor(),
        OnlySniper = getRandomColor(),
        IgnoreWraith = getRandomColor(),
        SmartSpecialKilling = getRandomColor()
    }
    
    -- Main Version Button
    local mainBtn = Instance.new("TextButton")
    mainBtn.Size = UDim2.new(0.9, 0, 0, 30)
    mainBtn.Position = UDim2.new(0.05, 0, 0, 40)
    mainBtn.BackgroundColor3 = currentVersion == "Main" and versionButtonColors.Main or Color3.fromRGB(90, 90, 90)
    mainBtn.Text = "Main Version - Aim all zombies"
    mainBtn.Parent = versionFrame
    mainBtn.TextColor3 = Color3.new(1,1,1)
    mainBtn.Font = Enum.Font.SourceSansBold
    mainBtn.TextSize = 14
    
    -- Only Sniper Version Button
    local sniperBtn = Instance.new("TextButton")
    sniperBtn.Size = UDim2.new(0.9, 0, 0, 30)
    sniperBtn.Position = UDim2.new(0.05, 0, 0, 80)
    sniperBtn.BackgroundColor3 = currentVersion == "OnlySniper" and versionButtonColors.OnlySniper or Color3.fromRGB(90, 90, 90)
    sniperBtn.Text = "Sniper Only - Aim only sniper zombies"
    sniperBtn.Parent = versionFrame
    sniperBtn.TextColor3 = Color3.new(1,1,1)
    sniperBtn.Font = Enum.Font.SourceSansBold
    sniperBtn.TextSize = 14
    
    -- Ignore Wraith Version Button
    local ignoreWraithBtn = Instance.new("TextButton")
    ignoreWraithBtn.Size = UDim2.new(0.9, 0, 0, 30)
    ignoreWraithBtn.Position = UDim2.new(0.05, 0, 0, 120)
    ignoreWraithBtn.BackgroundColor3 = currentVersion == "IgnoreWraith" and versionButtonColors.IgnoreWraith or Color3.fromRGB(90, 90, 90)
    ignoreWraithBtn.Text = "Ignore Wraith - Skip wraith zombies"
    ignoreWraithBtn.Parent = versionFrame
    ignoreWraithBtn.TextColor3 = Color3.new(1,1,1)
    ignoreWraithBtn.Font = Enum.Font.SourceSansBold
    ignoreWraithBtn.TextSize = 14
    
    -- Smart Special Killing Version Button
    local smartSpecialBtn = Instance.new("TextButton")
    smartSpecialBtn.Size = UDim2.new(0.9, 0, 0, 30)
    smartSpecialBtn.Position = UDim2.new(0.05, 0, 0, 160)
    smartSpecialBtn.BackgroundColor3 = currentVersion == "SmartSpecialKilling" and versionButtonColors.SmartSpecialKilling or Color3.fromRGB(90, 90, 90)
    smartSpecialBtn.Text = "Smart Kill - Priority system"
    smartSpecialBtn.Parent = versionFrame
    smartSpecialBtn.TextColor3 = Color3.new(1,1,1)
    smartSpecialBtn.Font = Enum.Font.SourceSansBold
    smartSpecialBtn.TextSize = 14
    
    -- Version Button Handlers
    mainBtn.MouseButton1Click:Connect(function()
        currentVersion = "Main"
        mainBtn.BackgroundColor3 = versionButtonColors.Main
        sniperBtn.BackgroundColor3 = Color3.fromRGB(90, 90, 90)
        ignoreWraithBtn.BackgroundColor3 = Color3.fromRGB(90, 90, 90)
        smartSpecialBtn.BackgroundColor3 = Color3.fromRGB(90, 90, 90)
        versionFrame.Visible = false
    end)
    
    sniperBtn.MouseButton1Click:Connect(function()
        currentVersion = "OnlySniper"
        mainBtn.BackgroundColor3 = Color3.fromRGB(90, 90, 90)
        sniperBtn.BackgroundColor3 = versionButtonColors.OnlySniper
        ignoreWraithBtn.BackgroundColor3 = Color3.fromRGB(90, 90, 90)
        smartSpecialBtn.BackgroundColor3 = Color3.fromRGB(90, 90, 90)
        versionFrame.Visible = false
    end)
    
    ignoreWraithBtn.MouseButton1Click:Connect(function()
        currentVersion = "IgnoreWraith"
        mainBtn.BackgroundColor3 = Color3.fromRGB(90, 90, 90)
        sniperBtn.BackgroundColor3 = Color3.fromRGB(90, 90, 90)
        ignoreWraithBtn.BackgroundColor3 = versionButtonColors.IgnoreWraith
        smartSpecialBtn.BackgroundColor3 = Color3.fromRGB(90, 90, 90)
        versionFrame.Visible = false
    end)
    
    smartSpecialBtn.MouseButton1Click:Connect(function()
        currentVersion = "SmartSpecialKilling"
        mainBtn.BackgroundColor3 = Color3.fromRGB(90, 90, 90)
        sniperBtn.BackgroundColor3 = Color3.fromRGB(90, 90, 90)
        ignoreWraithBtn.BackgroundColor3 = Color3.fromRGB(90, 90, 90)
        smartSpecialBtn.BackgroundColor3 = versionButtonColors.SmartSpecialKilling
        versionFrame.Visible = false
    end)
    
    -- Version Select Button Handler
    versionSelectBtn.MouseButton1Click:Connect(function()
        versionFrame.Visible = not versionFrame.Visible
    end)
    
    -- Close button
    local closeBtn = Instance.new("TextButton")
    closeBtn.Size = UDim2.new(0, 25, 0, 25)
    closeBtn.Position = UDim2.new(0.95, -25, 0, 2)
    closeBtn.BackgroundTransparency = 1
    closeBtn.Text = "X"
    closeBtn.TextColor3 = Color3.new(1,1,1)
    closeBtn.Font = Enum.Font.SourceSansBold
    closeBtn.TextSize = 16
    closeBtn.Parent = versionFrame
    
    closeBtn.MouseButton1Click:Connect(function()
        versionFrame.Visible = false
    end)
end

createVersionSelectionGUI()

----------------------------------------------------------------
-- SPECIAL ZOMBIE IDENTIFICATION FUNCTIONS
----------------------------------------------------------------
local function isSniperZombie(zombie)
    return zombie.Name:lower():find("sniper") or zombie.Name:lower():find("shooter")
end

local function isWraithZombie(zombie)
    return zombie.Name:lower():find("wraith")
end

----------------------------------------------------------------
-- SMART SPECIAL KILLING FUNCTIONS (NEW)
----------------------------------------------------------------
local function isGuardianZombie(zombie)
    return zombie.Name == "GuardianZombie" or (zombie:FindFirstChild("IsGuardian") and zombie.IsGuardian.Value == true)
end

local function isBossZombie(zombie)
    return zombie.Name == "Boss" or (zombie:FindFirstChild("IsBoss") and zombie.IsBoss.Value == true)
end

local function shouldIgnoreBoss(boss)
    -- Check if boss is in ignore timers
    if bossIgnoreTimers[boss] and os.clock() - bossIgnoreTimers[boss] < BOSS_IGNORE_DURATION then
        return true
    end
    
    -- Check if boss HP is below threshold
    local humanoid = boss:FindFirstChild("Humanoid")
    if humanoid and humanoid.Health / humanoid.MaxHealth <= BOSS_IGNORE_HP_THRESHOLD then
        -- Add to ignore timers
        bossIgnoreTimers[boss] = os.clock()
        return true
    end
    
    return false
end

local function cleanupBossTimers()
    local currentTime = os.clock()
    for boss, timer in pairs(bossIgnoreTimers) do
        if not boss:IsDescendantOf(workspace) or currentTime - timer >= BOSS_IGNORE_DURATION then
            bossIgnoreTimers[boss] = nil
        end
    end
end

----------------------------------------------------------------
-- ESP Functions
----------------------------------------------------------------
local function clearESP()
    for _, v in pairs(espObjects) do
        if v and v.Parent then
            v:Destroy()
        end
    end
    table.clear(espObjects)
end

local function createESP(obj)
    if obj:IsA("Model") and not obj:FindFirstChild("ESP_Highlight") then
        local highlight = Instance.new("Highlight")
        highlight.Name = "ESP_Highlight"
        highlight.Adornee = obj
        highlight.FillColor = Color3.new(1, 0, 0)
        highlight.OutlineColor = Color3.new(1, 0, 0)
        highlight.FillTransparency = 1
        highlight.OutlineTransparency = 0
        highlight.Parent = obj
        table.insert(espObjects, highlight)

        local billboard = Instance.new("BillboardGui")
        billboard.Name = "ESP_Billboard"
        billboard.Adornee = obj
        billboard.Size = UDim2.new(0, 100, 0, 50)
        billboard.StudsOffset = Vector3.new(0, 3, 0)
        billboard.AlwaysOnTop = true
        billboard.Parent = obj

        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(1, 0, 1, 0)
        label.BackgroundTransparency = 1
        label.TextColor3 = Color3.new(1, 0, 0)
        label.TextSize = 16
        label.Font = Enum.Font.SourceSansBold
        label.Text = obj.Name
        label.Parent = billboard

        table.insert(espObjects, billboard)
    end
end

local function updateESP()
    clearESP()
    if espVisible then
        for _, z in ipairs(zombiesFolder:GetChildren()) do
            createESP(z)
        end
    end
end

-- ESP Toggle Handler
toggleEspBtn.MouseButton1Click:Connect(function()
    espVisible = not espVisible
    toggleEspBtn.Text = espVisible and "Hide Body ESP Zombies" or "Show Body ESP Zombies"
    updateESP()
end)

zombiesFolder.ChildAdded:Connect(function(child)
    if espVisible then
        task.wait(0.1)
        createESP(child)
    end
end)

----------------------------------------------------------------
-- SMOOTH AIMING FUNCTIONS (NEW)
----------------------------------------------------------------
local function smoothAim(targetPosition)
    if not smoothAimEnabled then
        camera.CFrame = CFrame.new(camera.CFrame.Position, targetPosition)
        lastCameraCFrame = camera.CFrame
        return
    end
    
    local currentPosition = camera.CFrame.Position
    local targetLookVector = (targetPosition - currentPosition).Unit
    local targetCFrame = CFrame.new(currentPosition, currentPosition + targetLookVector)
    
    -- Apply smoothness
    local smoothFactor = 1 / smoothnessAmount
    local newCFrame = lastCameraCFrame:Lerp(targetCFrame, smoothFactor)
    
    camera.CFrame = newCFrame
    lastCameraCFrame = newCFrame
end

----------------------------------------------------------------
-- AIMBOT + WALL CHECK FUNCTIONS (UPDATED WITH VERSION LOGIC)
----------------------------------------------------------------
local function isVisible(targetPart)
    local origin = camera.CFrame.Position
    local direction = (targetPart.Position - origin).Unit * 500
    local raycastParams = RaycastParams.new()
    raycastParams.FilterType = Enum.RaycastFilterType.Blacklist
    raycastParams.FilterDescendantsInstances = {player.Character, camera}
    raycastParams.IgnoreWater = true

    local result = workspace:Raycast(origin, direction, raycastParams)
    return result and result.Instance and targetPart:IsDescendantOf(result.Instance.Parent)
end

local function getClosestZombieInFOV()
    local screenCenter = Vector2.new(camera.ViewportSize.X / 2, camera.ViewportSize.Y / 2)
    local closestDist = aimFOV
    local closestZombie = nil

    for _, zombie in ipairs(zombiesFolder:GetChildren()) do
        if zombie:IsA("Model") and zombie:FindFirstChild(aimPartName) then
            -- Version-specific filtering
            if currentVersion == "OnlySniper" and not isSniperZombie(zombie) then
                continue
            elseif currentVersion == "IgnoreWraith" and isWraithZombie(zombie) then
                continue
            elseif currentVersion == "SmartSpecialKilling" and isBossZombie(zombie) and shouldIgnoreBoss(zombie) then
                continue
            end
            
            local part = zombie[aimPartName]
            local screenPos, onScreen = camera:WorldToScreenPoint(part.Position)
            if onScreen then
                local dist = (Vector2.new(screenPos.X, screenPos.Y) - screenCenter).Magnitude
                local visible = true
                if wallCheckEnabled then
                    visible = isVisible(part)
                end
                if dist < closestDist and visible then
                    closestDist = dist
                    closestZombie = zombie
                end
            end
        end
    end

    -- Second pass for Smart Special Killing: Check for GuardianZombies near the closest zombie
    if currentVersion == "SmartSpecialKilling" and closestZombie then
        local closestZombiePos = closestZombie:FindFirstChild(aimPartName).Position
        local guardianZombie = nil
        local guardianDistance = math.huge
        
        for _, zombie in ipairs(zombiesFolder:GetChildren()) do
            if zombie:IsA("Model") and isGuardianZombie(zombie) and zombie:FindFirstChild(aimPartName) then
                local part = zombie[aimPartName]
                local screenPos, onScreen = camera:WorldToScreenPoint(part.Position)
                
                if onScreen then
                    local dist = (Vector2.new(screenPos.X, screenPos.Y) - screenCenter).Magnitude
                    local worldDistance = (part.Position - closestZombiePos).Magnitude
                    
                    -- Check if this GuardianZombie is within priority range of the closest zombie
                    if worldDistance <= GUARDIAN_PRIORITY_RANGE and dist <= aimFOV then
                        if worldDistance < guardianDistance then
                            guardianDistance = worldDistance
                            guardianZombie = zombie
                        end
                    end
                end
            end
        end
        
        -- If we found a GuardianZombie near the closest zombie, prioritize it
        if guardianZombie then
            return guardianZombie
        end
    end
    
    return closestZombie
end

----------------------------------------------------------------
-- HITBOX EXPANDER FUNCTIONS (UPDATED FOR SNIPER ZOMBIES - 4x4x4)
----------------------------------------------------------------
local function expandHeadHitbox(zombie)
    if zombie:IsA("Model") and zombie:FindFirstChild("Head") then
        local head = zombie.Head
        if head:IsA("BasePart") then
            if not head:FindFirstChild("OriginalSize") then
                local originalSize = Instance.new("Vector3Value")
                originalSize.Name = "OriginalSize"
                originalSize.Value = head.Size
                originalSize.Parent = head
            end
            
            -- Make hitbox 4x4x4 for sniper zombies
            if isSniperZombie(zombie) then
                head.Size = Vector3.new(4, 4, 4) -- 4x4x4 hitbox for sniper zombies
            else
                head.Size = Vector3.new(5, 5, 5) -- Normal hitbox for other zombies
            end
            
            head.Transparency = 0.5
            head.CanCollide = false
            head.Material = Enum.Material.ForceField
        end
    end
end

local function resetHeadHitbox(zombie)
    if zombie:IsA("Model") and zombie:FindFirstChild("Head") then
        local head = zombie.Head
        if head:IsA("BasePart") then
            if head:FindFirstChild("OriginalSize") then
                head.Size = head.OriginalSize.Value
                head.Transparency = 0
                head.CanCollide = true
                head.Material = Enum.Material.Plastic
                head.OriginalSize:Destroy()
            else
                head.Size = Vector3.new(1, 1, 1)
                head.Transparency = 0
                head.CanCollide = true
                head.Material = Enum.Material.Plastic
            end
        end
    end
end

local function updateAllZombies()
    for _, zombie in ipairs(zombiesFolder:GetChildren()) do
        if hitboxEnabled then
            expandHeadHitbox(zombie)
        else
            resetHeadHitbox(zombie)
        end
    end
end

-- Hitbox Toggle Handler
hitboxToggle.MouseButton1Click:Connect(function()
    hitboxEnabled = not hitboxEnabled
    hitboxToggle.Text = hitboxEnabled and "Expand Hitbox: ON" or "Expand Hitbox: OFF"
    updateAllZombies()
end)

zombiesFolder.ChildAdded:Connect(function(zombie)
    task.wait(0.2)
    if hitboxEnabled then
        expandHeadHitbox(zombie)
    end
end)

----------------------------------------------------------------
-- MAIN LOOP (UPDATED WITH SNIPER AIM OFFSET)
----------------------------------------------------------------
RunService.RenderStepped:Connect(function()
    if draggingSlider then
        local mouseX = UserInputService:GetMouseLocation().X
        local sliderX = slider.AbsolutePosition.X
        local relativeX = math.clamp(mouseX - sliderX, 0, 200)

        sliderKnob.Position = UDim2.new(0, relativeX, 0, 0)
        aimFOV = math.clamp(math.floor((relativeX / 200) * 300), 20, 300)
        fovLabel.Text = "Aim FOV: " .. aimFOV
    end

    fovCircle.Position = camera.ViewportSize / 2
    fovCircle.Radius = aimFOV
    fovCircle.Visible = fovVisible
    
    -- Clean up boss timers
    if currentVersion == "SmartSpecialKilling" then
        cleanupBossTimers()
    end

    if aimLockActive then
        local closestZombie = getClosestZombieInFOV()
        if closestZombie then
            local targetPart = closestZombie[aimPartName]
            local targetPosition = targetPart.Position
            
            -- Aim slightly higher for sniper zombies
            if isSniperZombie(closestZombie) then
                targetPosition = targetPosition + Vector3.new(0, 0.5, 0) -- Aim higher for sniper zombies
            end
            
            smoothAim(targetPosition)
        end
    end
end)

-- Keybind for PC users
if isPC then
    UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if not gameProcessed and input.KeyCode == aimbindKey then
            aimLockActive = not aimLockActive
            toggleButton.Text = aimLockActive and "AimLock On" or "AimLock Off"
            toggleButton.BackgroundColor3 = aimLockActive and Color3.fromRGB(0,255,0) or Color3.fromRGB(255,0,0)
        end
    end)
end

-- Initialize hitboxes
updateAllZombies()
