--// Ultimate Zombie Aimlock Script //--
--// Features: Working FOV System, Aimlock, ESP, Wall Check //--

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local camera = workspace.CurrentCamera
local player = Players.LocalPlayer

-- Config
local aimPartName = "Head"
local zombiesFolder = workspace:WaitForChild("Zombies")

-- State
local aimLockActive = false
local aimFOV = 100
local draggingSlider = false
local uiVisible = true
local fovVisible = false  -- Default off
local espVisible = false
local wallCheckEnabled = true
local hitboxEnabled = false

-- ESP storage
local espObjects = {}

----------------------------------------------------------------
-- FIXED FOV CIRCLE SYSTEM
----------------------------------------------------------------
local fovCircle = Drawing.new("Circle")
fovCircle.Visible = fovVisible
fovCircle.Color = Color3.fromRGB(0, 170, 255)
fovCircle.Thickness = 2
fovCircle.NumSides = 64
fovCircle.Filled = false

local function updateFOVCircle()
    fovCircle.Radius = aimFOV
    fovCircle.Position = Vector2.new(camera.ViewportSize.X/2, camera.ViewportSize.Y/2)
    fovCircle.Visible = fovVisible
end

updateFOVCircle()  -- Initialize

----------------------------------------------------------------
-- GUI SYSTEM
----------------------------------------------------------------
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "AimLockGui"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

-- UI Toggle Button
local toggleUIBtn = Instance.new("TextButton")
toggleUIBtn.Size = UDim2.new(0, 100, 0, 40)
toggleUIBtn.Position = UDim2.new(0, 10, 0, 10)
toggleUIBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 255)
toggleUIBtn.Text = "Hide UI"
toggleUIBtn.Parent = screenGui
toggleUIBtn.TextColor3 = Color3.new(1,1,1)
toggleUIBtn.Font = Enum.Font.SourceSansBold
toggleUIBtn.TextSize = 20

-- Main Frame
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 260, 0, 420)
mainFrame.Position = UDim2.new(0.5, -130, 0.5, -210)
mainFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
mainFrame.BorderSizePixel = 0
mainFrame.Parent = screenGui
mainFrame.Active = true
mainFrame.Draggable = true

-- Toggle AimLock Button
local toggleButton = Instance.new("TextButton")
toggleButton.Size = UDim2.new(0, 200, 0, 40)
toggleButton.Position = UDim2.new(0, 30, 0, 10)
toggleButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
toggleButton.Text = "AimLock Off"
toggleButton.Parent = mainFrame
toggleButton.TextColor3 = Color3.new(1,1,1)
toggleButton.Font = Enum.Font.SourceSansBold
toggleButton.TextSize = 20

toggleButton.MouseButton1Click:Connect(function()
    aimLockActive = not aimLockActive
    toggleButton.Text = aimLockActive and "AimLock On" or "AimLock Off"
    toggleButton.BackgroundColor3 = aimLockActive and Color3.fromRGB(0,255,0) or Color3.fromRGB(255,0,0)
end)

-- FOV Controls (Fixed)
local fovLabel = Instance.new("TextLabel")
fovLabel.Size = UDim2.new(0, 200, 0, 25)
fovLabel.Position = UDim2.new(0, 30, 0, 60)
fovLabel.BackgroundTransparency = 1
fovLabel.TextColor3 = Color3.new(1,1,1)
fovLabel.Text = "Aim FOV: " .. aimFOV
fovLabel.Font = Enum.Font.SourceSans
fovLabel.TextSize = 18
fovLabel.Parent = mainFrame

local slider = Instance.new("TextButton")
slider.Size = UDim2.new(0, 200, 0, 20)
slider.Position = UDim2.new(0, 30, 0, 90)
slider.BackgroundColor3 = Color3.fromRGB(90, 90, 90)
slider.Text = ""
slider.Parent = mainFrame

local sliderKnob = Instance.new("Frame")
sliderKnob.Size = UDim2.new(0, 10, 0, 20)
sliderKnob.Position = UDim2.new((aimFOV - 20)/280, 0, 0, 0)  -- 20-300 range
sliderKnob.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
sliderKnob.Parent = slider

-- FOV Slider Logic (Fixed)
slider.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        draggingSlider = true
        -- Immediate update when clicking
        local mouseX = UserInputService:GetMouseLocation().X
        local sliderX = slider.AbsolutePosition.X
        local relativeX = math.clamp(mouseX - sliderX, 0, 200)
        
        aimFOV = math.floor(20 + (relativeX/200) * 280)  -- 20-300 range
        sliderKnob.Position = UDim2.new((aimFOV - 20)/280, 0, 0, 0)
        fovLabel.Text = "Aim FOV: " .. aimFOV
        updateFOVCircle()
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        draggingSlider = false
    end
end)

-- FOV Circle Toggle (Fixed)
local toggleFovBtn = Instance.new("TextButton")
toggleFovBtn.Size = UDim2.new(0, 200, 0, 40)
toggleFovBtn.Position = UDim2.new(0, 30, 0, 120)
toggleFovBtn.BackgroundColor3 = fovVisible and Color3.fromRGB(0,170,255) or Color3.fromRGB(255,255,0)
toggleFovBtn.Text = fovVisible and "Hide FOV Circle" or "Show FOV Circle"
toggleFovBtn.Parent = mainFrame
toggleFovBtn.TextColor3 = Color3.new(1,1,1)
toggleFovBtn.Font = Enum.Font.SourceSansBold
toggleFovBtn.TextSize = 20

toggleFovBtn.MouseButton1Click:Connect(function()
    fovVisible = not fovVisible
    toggleFovBtn.Text = fovVisible and "Hide FOV Circle" or "Show FOV Circle"
    toggleFovBtn.BackgroundColor3 = fovVisible and Color3.fromRGB(0,170,255) or Color3.fromRGB(255,255,0)
    updateFOVCircle()
end)

-- ESP Toggle
local toggleEspBtn = Instance.new("TextButton")
toggleEspBtn.Size = UDim2.new(0, 200, 0, 40)
toggleEspBtn.Position = UDim2.new(0, 30, 0, 170)
toggleEspBtn.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
toggleEspBtn.Text = "Show Body ESP Zombies"
toggleEspBtn.Parent = mainFrame
toggleEspBtn.TextColor3 = Color3.new(1,1,1)
toggleEspBtn.Font = Enum.Font.SourceSansBold
toggleEspBtn.TextSize = 20

-- Wall Check Toggle
local toggleWallCheckBtn = Instance.new("TextButton")
toggleWallCheckBtn.Size = UDim2.new(0, 200, 0, 40)
toggleWallCheckBtn.Position = UDim2.new(0, 30, 0, 220)
toggleWallCheckBtn.BackgroundColor3 = Color3.fromRGB(255, 100, 100)
toggleWallCheckBtn.Text = "Disable Wall Check"
toggleWallCheckBtn.Parent = mainFrame
toggleWallCheckBtn.TextColor3 = Color3.new(1,1,1)
toggleWallCheckBtn.Font = Enum.Font.SourceSansBold
toggleWallCheckBtn.TextSize = 20

-- Hitbox Toggle
local hitboxToggle = Instance.new("TextButton")
hitboxToggle.Size = UDim2.new(0, 200, 0, 40)
hitboxToggle.Position = UDim2.new(0, 30, 0, 270)
hitboxToggle.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
hitboxToggle.TextColor3 = Color3.new(1, 1, 1)
hitboxToggle.Font = Enum.Font.SourceSansBold
hitboxToggle.TextSize = 20
hitboxToggle.Text = "Expand Hitbox: OFF"
hitboxToggle.Parent = mainFrame

-- Hitbox Selection Buttons
local hitboxHeadBtn = Instance.new("TextButton")
hitboxHeadBtn.Size = UDim2.new(0, 95, 0, 40)
hitboxHeadBtn.Position = UDim2.new(0, 30, 0, 320)
hitboxHeadBtn.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
hitboxHeadBtn.Text = "Head"
hitboxHeadBtn.Parent = mainFrame
hitboxHeadBtn.TextColor3 = Color3.new(1,1,1)
hitboxHeadBtn.Font = Enum.Font.SourceSansBold
hitboxHeadBtn.TextSize = 18

local hitboxTorsoBtn = Instance.new("TextButton")
hitboxTorsoBtn.Size = UDim2.new(0, 95, 0, 40)
hitboxTorsoBtn.Position = UDim2.new(0, 135, 0, 320)
hitboxTorsoBtn.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
hitboxTorsoBtn.Text = "Torso"
hitboxTorsoBtn.Parent = mainFrame
hitboxTorsoBtn.TextColor3 = Color3.new(1,1,1)
hitboxTorsoBtn.Font = Enum.Font.SourceSansBold
hitboxTorsoBtn.TextSize = 18

-- UI Toggle Handler
toggleUIBtn.MouseButton1Click:Connect(function()
    uiVisible = not uiVisible
    mainFrame.Visible = uiVisible
    toggleUIBtn.Text = uiVisible and "Hide UI" or "Show UI"
end)

-- ESP Toggle Handler
toggleEspBtn.MouseButton1Click:Connect(function()
    espVisible = not espVisible
    toggleEspBtn.Text = espVisible and "Hide Body ESP Zombies" or "Show Body ESP Zombies"
    updateESP()
end)

-- Wall Check Toggle Handler
toggleWallCheckBtn.MouseButton1Click:Connect(function()
    wallCheckEnabled = not wallCheckEnabled
    toggleWallCheckBtn.Text = wallCheckEnabled and "Disable Wall Check" or "Enable Wall Check"
    toggleWallCheckBtn.BackgroundColor3 = wallCheckEnabled and Color3.fromRGB(255, 100, 100) or Color3.fromRGB(100, 255, 100)
end)

-- Hitbox Selection Handlers
hitboxHeadBtn.MouseButton1Click:Connect(function()
    aimPartName = "Head"
    hitboxHeadBtn.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
    hitboxTorsoBtn.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
end)

hitboxTorsoBtn.MouseButton1Click:Connect(function()
    aimPartName = "HumanoidRootPart"
    hitboxHeadBtn.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
    hitboxTorsoBtn.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
end)

-- Hitbox Toggle Handler
hitboxToggle.MouseButton1Click:Connect(function()
    hitboxEnabled = not hitboxEnabled
    hitboxToggle.Text = hitboxEnabled and "Expand Hitbox: ON" or "Expand Hitbox: OFF"
    updateAllZombies()
end)

----------------------------------------------------------------
-- ESP FUNCTIONS
----------------------------------------------------------------
local function clearESP()
    for _, v in pairs(espObjects) do
        if v and v.Parent then
            v:Destroy()
        end
    end
    table.clear(espObjects)
end

local function createESP(obj)
    if obj:IsA("Model") and not obj:FindFirstChild("ESP_Highlight") then
        local highlight = Instance.new("Highlight")
        highlight.Name = "ESP_Highlight"
        highlight.Adornee = obj
        highlight.FillColor = Color3.new(1, 0, 0)
        highlight.OutlineColor = Color3.new(1, 0, 0)
        highlight.FillTransparency = 1
        highlight.OutlineTransparency = 0
        highlight.Parent = obj
        table.insert(espObjects, highlight)

        local billboard = Instance.new("BillboardGui")
        billboard.Name = "ESP_Billboard"
        billboard.Adornee = obj
        billboard.Size = UDim2.new(0, 100, 0, 50)
        billboard.StudsOffset = Vector3.new(0, 3, 0)
        billboard.AlwaysOnTop = true
        billboard.Parent = obj

        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(1, 0, 1, 0)
        label.BackgroundTransparency = 1
        label.TextColor3 = Color3.new(1, 0, 0)
        label.TextSize = 16
        label.Font = Enum.Font.SourceSansBold
        label.Text = obj.Name
        label.Parent = billboard

        table.insert(espObjects, billboard)
    end
end

local function updateESP()
    clearESP()
    if espVisible then
        for _, z in ipairs(zombiesFolder:GetChildren()) do
            createESP(z)
        end
    end
end

zombiesFolder.ChildAdded:Connect(function(child)
    if espVisible then
        task.wait(0.1)
        createESP(child)
    end
end)

----------------------------------------------------------------
-- AIMBOT FUNCTIONS (With Fixed FOV)
----------------------------------------------------------------
local function isVisible(targetPart)
    if not wallCheckEnabled then return true end
    
    local origin = camera.CFrame.Position
    local direction = (targetPart.Position - origin).Unit * 500
    local raycastParams = RaycastParams.new()
    raycastParams.FilterType = Enum.RaycastFilterType.Blacklist
    raycastParams.FilterDescendantsInstances = {player.Character, camera}
    raycastParams.IgnoreWater = true

    local result = workspace:Raycast(origin, direction, raycastParams)
    return result and result.Instance and targetPart:IsDescendantOf(result.Instance.Parent)
end

local function getClosestZombieInFOV()
    local screenCenter = Vector2.new(camera.ViewportSize.X / 2, camera.ViewportSize.Y / 2)
    local closestDist = aimFOV
    local closestZombie = nil
    local closestActualDist = math.huge

    for _, zombie in ipairs(zombiesFolder:GetChildren()) do
        if zombie:IsA("Model") and zombie:FindFirstChild(aimPartName) then
            local part = zombie[aimPartName]
            local screenPos, onScreen = camera:WorldToScreenPoint(part.Position)
            if onScreen then
                local dist = (Vector2.new(screenPos.X, screenPos.Y) - screenCenter).Magnitude
                local actualDist = (part.Position - camera.CFrame.Position).Magnitude
                local visible = true
                if wallCheckEnabled then
                    visible = isVisible(part)
                end
                if dist < closestDist and visible and actualDist < closestActualDist then
                    closestDist = dist
                    closestActualDist = actualDist
                    closestZombie = zombie
                end
            end
        end
    end

    return closestZombie
end

----------------------------------------------------------------
-- HITBOX FUNCTIONS (Original 5x5x5 size)
----------------------------------------------------------------
local function expandHeadHitbox(zombie)
    if zombie:IsA("Model") and zombie:FindFirstChild("Head") then
        local head = zombie.Head
        if head:IsA("BasePart") then
            head.Size = Vector3.new(5, 5, 5)
            head.Transparency = 0.5
            head.CanCollide = false
            head.Material = Enum.Material.ForceField
        end
    end
end

local function resetHeadHitbox(zombie)
    if zombie:IsA("Model") and zombie:FindFirstChild("Head") then
        local head = zombie.Head
        if head:IsA("BasePart") then
            head.Size = Vector3.new(1, 1, 1)
            head.Transparency = 0
            head.Material = Enum.Material.Plastic
        end
    end
end

local function updateAllZombies()
    for _, zombie in ipairs(zombiesFolder:GetChildren()) do
        if hitboxEnabled then
            expandHeadHitbox(zombie)
        else
            resetHeadHitbox(zombie)
        end
    end
end

zombiesFolder.ChildAdded:Connect(function(zombie)
    task.wait(0.2)
    if hitboxEnabled then
        expandHeadHitbox(zombie)
    end
end)

----------------------------------------------------------------
-- MAIN LOOP (With Fixed FOV Updates)
----------------------------------------------------------------
RunService.RenderStepped:Connect(function()
    -- Update FOV slider
    if draggingSlider then
        local mouseX = UserInputService:GetMouseLocation().X
        local sliderX = slider.AbsolutePosition.X
        local relativeX = math.clamp(mouseX - sliderX, 0, 200)

        aimFOV = math.floor(20 + (relativeX / 200) * 280)  -- 20-300 range
        sliderKnob.Position = UDim2.new((aimFOV - 20)/280, 0, 0, 0)
        fovLabel.Text = "Aim FOV: " .. aimFOV
        updateFOVCircle()
    end

    -- Update FOV circle
    updateFOVCircle()

    -- Aimlock logic
    if aimLockActive then
        local closestZombie = getClosestZombieInFOV()
        if closestZombie then
            local targetPart = closestZombie[aimPartName]
            camera.CFrame = CFrame.new(camera.CFrame.Position, targetPart.Position)
        end
    end
end)
